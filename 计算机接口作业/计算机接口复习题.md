## 8255A
----
A、B、C 三个端口，每个端口 8 位，通过编程设定其位输入口或输出口，可用来和外设传送信息，C 口还可作控制/状态口，用于输出控制信号和输入状态信号。

> <font color="#ff0000">端口 A</font>：有 `3` 种工作方式 (<span style="background:#d3f8b6">方式 0、方式 1、方式 2</span>)、对外 `8` 根引脚 PA7 ~ PA0
> <font color="#ff0000">端口 B</font>：有 `2` 种工作方式 (<span style="background:#d3f8b6">方式 0、方式 1</span>)、对外 `8` 根引脚 PB7 ~ PB0
> <font color="#ff0000">端口 C</font>：对外引脚 PC0~PC7，分成上下两个部分，只能工作在方式 0
  
|  |工作方式 | 适用的端口 |
| -------- | -------- | -------- |
| 0    | 基本型输入/输出| A 口、B 口、C 口|
| 1    | 选通型输入/输出| A 口、B 口     |
| 2    | 双向传输      | A 口         |
### 方式 0
![](https://i.imgur.com/VR7KNxZ.png)
### 方式 1
![](https://i.imgur.com/MuMQDZh.png)
若输入使用查询方式应先查询 IBF
若输入使用中断方式：
* A 口：PC4=1
* B 口：PC2=1

若输出使用查询方式应先查询 OBF
若输出使用中断方式：
* A 口：PC6=1
* B 口：PC2=1
### 方式 2
![](https://i.imgur.com/ZrwYnBb.png)
- 方式选择控制字 
  ![](https://pan.lmio.xyz/pic/50d59a7ac879639025f206d062c0f1a9.png)
- 按位操作控制字
  ![](https://pan.lmio.xyz/pic/e5913a116f46c411ab0dbbc77eb0a05a.png)
   设置 `PC0` 为置位，则：<span style="background:#d3f8b6">00000001</span>   
   设置 `PC4` 为复位，则：<span style="background:#d3f8b6">00001000 </span>  
- 与处理器连接
  ![](https://pan.lmio.xyz/pic/357f4bed71a2c73440d30221c8eae200.png)

-  用 8255A 的 B 口连接一个七段数码管，该数码管采用共阳 LED，低有效驱动显示。要求把自己学号最末 2 位数字先后显示在数码管上。例如学号为”XXXX26“，则先显示数字“2”，延迟 20ms，再显示数字“6”，写出核心程序段。

   ![](https://raw.githubusercontent.com/Clear-Love/image/main/image/2022-11-16-19-58-54-image.png)

   > 共阳极数码管 0-9：_0xc0, 0xf9, 0xa4, 0xb0, 0x99, 0x92, 0x82, 0xf8, 0x80, 0x90_
  
   ```x86asm
    mov dx, 21BH ;控制端口
    mov al, 90H  ;b口方式0输出
    out dx, al
    mov dx, 219H ;b口
    mov al, B0H ;b口输出3
    out dx, al
    call delay20ms ;延迟20ms
    mov al, 82H ;b口输出6
    out dx, al 
   ```


## 8255A 程序设计
----
### 8255A 初始化编程
* <font color="#ff0000">步骤一</font>：方式选择控制字->控制口，目的选择某一口的工作方式
* <font color="#ff0000">步骤二</font>：
    * 当工作方式选择为方式 1 或方式 2 时，把 C 口置 0/置 1 控制字→控制口，目的是禁止/允许某一口提中断
```
MOV DX, 20BH	      ;控制寄存器端口地址为FF83H
MOV AL, 10000110B  ;A口方式0, 数据输出, B口方式1, 数据输入
OUT DX, AL	      ;将控制字写入控制端
MOV AL, 00000101     ;C口按位置0/置1控制字
OUT  DX, AL	      ;写入控制端
```
  -   一、课本 P110-112
![](https://raw.githubusercontent.com/Clear-Love/image/main/image/p110.jpg)
![](https://raw.githubusercontent.com/Clear-Love/image/main/image/P111.jpg)


-   二、编程及编写注释
    
    -   实验程序注释：
        
        ```x86asm
        ;汇编语言程序
        code segment
        assume cs:code
        portA
        equ 400H ;PA口地址
        go:
            mov dx,porta+3 ;控制端口地址
            mov al,80h ;控制字写入
            out dx,al ;三端口均初始化为方式0输出
        L0:
            mov si,24 ;数据偏移地址
            mov bx,1 ;低16位初始值设为1（一个灯亮）
            mov c1,0 ;高8位初始值设为0
        L1:
            mov ah,OBH ;命令字 检查键盘状态
            Int 21h ;有无按键
            Cmp al,0ffH ;FFH代表无输入
            Jz exit ;有输入退出程序
            mov dx,porta ;A口地址
            mov al,bl ;输出24位数 初始值
            out dx,al ;输出到端口A
            Inc dx ;dx加一，B口地址
            mov al,bh ;输入到B口地址
            out dx,al
            Inc dx ;c口地址
            mov al,cl ;输入到c口地址
            Out dx,al
            Call delay05 ;延时
            SHL bx,1 ;低16位左移一位
            Rcl c1,1 ;高8位左移一位
            dec si ;地址减一
            jnz L1 ;si不等于0
            Jmp L0 ;重新开始
        Exit:
            mov ah,4ch ;命令字
            Int 21h ;带返回码结束，al=返回码
        
        delay05 proc near ;循环延时子程序
            push cx ;cx,bx入程序栈
            push bx
            mov cx,0000H ;cx归零
        d1:
            mov bx,1200h ;延时长度
        d2:
            dec bx ;循环减一 
            jnz d2
            loop dl
            pop bx ;cx,bx出栈
            pop cx
            ret ;返回
        delay05 endp ;子程序结束
        Code ends ;程序结束
            End go
        ```
        
    -   2. 若某个 8255A 端口地址范围为 260H~26FH, 请使用 74LS138 实现片选电路, 并编写用 PCT 输出一个负脉冲的程序。
        
        **片选电路**
        
        ![](https://raw.githubusercontent.com/Clear-Love/image/main/image/%E7%89%87%E9%80%89%E7%94%B5%E8%B7%AF.jpg)

        **程序：**
        
        ```x86asm
        mov dx, 263H ;控制端口
        mov al,10000000B ;初始化
        out dx, al
        mov dx, 262H ;C口
        mov al, 0FH ;PC7高电平
        out dx, al
        call delay ;延迟
        mov al, 0EH ;PC7低电平
        out dx, al
        call delay
        mov al, 0FH ;;PC7高电平
        out dx, al
        hlt
        ```
        
    -   3. 设计一个用 8255 连接打印机的接口电路，要求采用中断方式，将缓冲区中的 1000 个字符送打印机打印。
        
        **接口电路：**
        
		![](https://raw.githubusercontent.com/Clear-Love/image/main/image/%E6%8E%A5%E5%8F%A3%E7%94%B5%E8%B7%AF.jpg)

        
        **代码：**
        
        ```x86asm
        mov dx, 21BH ;控制端口 这里设8255A的控制口地址为21BH
        mov al, 10100000B ;A口方式一输出
        out dx, al ;置位控制字送控制端口
        mov dx, 21AH ;c口
        mov al 0DH ;允许中断请求，需要置INTEA=1，即置PC6=1
        out dx, al
        lea si, buf ;载入缓冲区buf地址
        mov cx, 3E8H ;buf大小
        wait:
            mov dx, 21AH ;C口
            in al, dx ;查询发送中断
            and al, 08H ;查发送中断PC3
            jz L ;无中断请求则等待
            mov dx 218H ;若有中断请求 A口写入数据
            mov al, [si] ;发送给打印机
            out dx, al
            inc si ;内存地址加1
            dec cx  ;传送字节数减1
            jnz wait
        hlt
        ```



## 8251A 串行接口
----
- 初始化编程
  ![](https://pan.lmio.xyz/pic/d7b15d80d79fcb7cd8e5fb3c16ada383.png)

- 方式控制字
  ![](https://pan.lmio.xyz/pic/5b26959ad324edf972700a4d5a9bada1.png)
- 命令控制字
  ![](https://pan.lmio.xyz/pic/3965a7a054f3eec4b2715943a5c377dd.png)
- 状态字
  ![](https://pan.lmio.xyz/pic/b2f23db1512a1fc8ecd3b1f4d1103a65.png)


##### 教材 P131-133 完成课后的选择题、填空题

![](https://raw.githubusercontent.com/Clear-Love/image/main/image/a3ebfd633ff5b83afbf639b433d9648.jpg)
![](https://raw.githubusercontent.com/Clear-Love/image/main/image/ca9c1a120b16eac1aa48b4d6341be7b.jpg)
![](https://raw.githubusercontent.com/Clear-Love/image/main/image/db6cae5cac875bbfa9e3f31e3b26810.jpg)


##### 设计题

- 1. 教材 P133【设计题】第 1 题:
  某系统中使用可编程串行接口芯片 8251A 工作在异步方式，7 位数字, 不带校验 1.5 位停止位，波特率系数为 64，允许发送和接收，其控制端口地址为 239H, 请编写初始化程序。
	
```armasm
MOV DX, 239H ;8251A控制口地址
MOV AL, 10001011B ;方式控制字
OUT DX, AL
MOV AL, 00010101B ;操作命令字
OUT DX, AL
```

- 2. 一个异步串行发送器，发送字符的 7 位 ASCII 码，另外有一位偶校验位，1 个停止位。若每秒钟发送 100 个字符，它的波特率和位周期是多少？
	  
	7 位 ASCII 码+1 位奇偶校验位+1 位停止位+1 位起始位 =10
	则发送一个字符需要 10 位
	波特率 = 10×100 = 1000
	位周期 = 1/1000 = 0.001

- 3. 已知 8251A 的方式控制字格式。请回答：
	1. 当方式控制字为 FEH 时，发送英文字母“C”时的 TxD 波形（写出高低值，并画出波形图）
	2. 若此时引脚 TxC 的输入频率为 307.2kHz，则串行信息的发送波特率是多少？
	![](https://raw.githubusercontent.com/Clear-Love/image/main/image/20221205222013.png)

	1. 方式控制字 FEH = 11111110B  此时 8251 工作在异步方式，8 位数字，偶校验，2 位停止位则 TXD 的波形为 ：001000011111 
	![](https://raw.githubusercontent.com/Clear-Love/image/main/image/dc717e9f72465f913fc6b880845272c.jpg)

	2. 8251A 的波特率系数为 16  则波特率 = 307200/16 = 19200


## 8253 计数器/定时器
----
![](https://pan.lmio.xyz/pic/7ede3f8429a7c6c67716f7164627db15.png)
![](https://pan.lmio.xyz/pic/1dd3845299a590bc1bd3d2ff51f8e044.png)

### 初始化编程
先写控制字，再送计数初值  
计数初值一次只能写入8位（先写低8位，后写高8位（可不写））  
控制字写入控制口，每个计数器的计数初值写入各自计数器口  
写入的顺序：按通道序号分别写入，按内容分别写入

- 方式控制字
  ![](https://pan.lmio.xyz/pic/bce1ac1d2551722e176660b372d46229.png)

### 一、完成教材 P148-150 的选择题、填空题
![](https://raw.githubusercontent.com/Clear-Love/image/main/image/2e842f06f23fea1efabd517fe937b31.jpg)
![](https://raw.githubusercontent.com/Clear-Love/image/main/image/3074cc13e1182bda845a3d1007f666d.jpg)
![](https://raw.githubusercontent.com/Clear-Love/image/main/image/df4663fdc791c241e2fd0b392243748.jpg)

### 二、完成教材 P150【设计题】第 1 题、第 2 题

1. 用 8253 的通道 1 进行计数，要求每计到 100 时产生一个中断请求信号.8253 的端口地址为 200H～203H, 要求：画出 8253 的硬件连接图，然后对 8253 进行初始化。
	硬件连接图：![](https://raw.githubusercontent.com/Clear-Love/image/main/image/bf7410fc5ba5bc1fa0df2cf49386d75.jpg)

	
	需要循环技术，计数器 1 可以工作在方式二
	计数初值：100 = 64H 读取计数器低八位即可以二进制计数
	则控制字为：01010100B
	
```armasm
MOV DX, 203H ;8253控制端口
MOV AL, 01010100B ;写计数器1控制字
OUT DX, AL
MOV DX, 201H ;8253计数器1控制端口
MOV AL, 64H ;写计数器1初始值
OUT DX, AL 
```



1. 已知 8253 的计数时钟频率为 1MHz, 若要求 8253 的计数通道 1, 每隔 10ms 向 CPU 申请一次中断，请对 8253 进行初始化编程。
	
	CLK1 = 1MHz = 1μs = 10^-6s
	要产生的周期为 10^-2s = 100Hz 
	计数初值：10^6/100 = 10000
	控制字：01010100B
	
```armasm
MOV DX, 203H ;8253控制端口
MOV AL, 01010100B ;写计数器1控制字
OUT DX, AL
MOV DX, 201H ;8253计数器1控制端口
MOV AL, 10000 ;写计数器1初始值
OUT DX, AL
```



## 8259A 中断控制器
----
### 8259A 的中断优先级

- <font color="#ff0000">固定优先级方式</font>
  在固定优先级方式中，IR7～IR0 的中断优先级是由系统确定的。优先级由高到低的顺序是：IR0, IR1, IR2, …, IR7。其中，IR0的优先级最高，IR7的优先级最低。

- <font color="#ff0000">自动循环优先级方式</font>
  在自动循环优先权方式中，IR7～IR0 的优先级别是可以改变的，而且是自动改变。其变化规律是：当某一个中断请求 `IRi` 服务结束后，该中断的优先级自动降为最低，而紧跟其后的中断请求 `IR(i＋1)` 的优先级自动升为最高。
  
  开始的时候，优先级从高到低是 `IR0, IR1, IR2, …, IR7`。某时刻，IR4 正在被 CPU 处理。处理完成后，IR4 的优先级变为最低，IR5 的优先级变为最高，也就是说，新的优先级序列从高到低是 `IR5,IR6,IR7,IR0,IR1,IR2,IR3,IR4`.
  
  在自动循环优先级方式中，又分为 **普通自动循环方式** 和 **特殊自动循环方式** 两种。
  
  1. <font color="#ff0000">普通自动循环</font>：IR0～IR7 中的初始最低优先级由系统指定，即指定 IR7 的优先级最低。
  2. <font color="#ff0000">特殊自动循环</font>：IR0～IR7 中的初始最低优先级由用户指定（<span style="background:#d3f8b6">通过 OCW2</span>）。


### 中断嵌套方式

8259A的中断嵌套方式分为<font color="#ff0000">普通嵌套</font>（normal nested mode）和<font color="#ff0000">特殊完全嵌套</font>（The Special Fully Nest Mode）两种。

- **普通嵌套方式**
  
  也叫做完全嵌套或者普通完全嵌套。此方式是8259A在初始化时默认选择的方式。其特点是：<span style="background:#d3f8b6">IR0优先级最高，IR7优先级最低</span>。在CPU中断服务期间，若有新的中断请求到来，只允许比当前服务的优先级更**高**的中断请求进入，对于“同级”或“低级”的中断请求则禁止响应。

- **特殊完全嵌套方式**
  
  其特点是：IR7～IR0 的优先级顺序与普通嵌套方式相同；<font color="#ff0000">不同之处</font>是在 CPU 中断服务期间，除了允许高级别中断请求进入外，还允许同级中断请求进入，从而实现了对同级中断请求的特殊嵌套。
  
  <span style="background: #d3f8b6 ">在多片 8259A 级联的情况下</span>，<font color=" #ff0000 ">主片通常设置为特殊完全嵌套方式，从片设置为普通嵌套方式</font>。当主片响应某一个从片的中断请求时，从片中的 IR7～IR0 的请求都是通过主片中的某个 `IRi` 请求引入的。因此从片的 IR7～IR0 对于主片 `IRi` 来说，它们属于同级，只有主片工作于特殊完全嵌套方式时，从片才能实现完全嵌套。
  
  比如从片的 INT 连接到主片的 IR2，假设此时 CPU 正在响应从片 IR4 的中断请求，在中断处理过程中，从片 IR3 的中断到来，于是主片 IR2 再次请求中断，理论上从片 IR3 的优先级高于 IR4，也就是说 CPU 应该暂停从片 IR4 的中断处理过程，转而处理从片 IR3 的中断。但是从片的 IR0~IR7 都是通过主片的 IR2 引入的，因为 CPU 正在服务于主片的 IR2，这时 IR2 再次请求中断，对于普通嵌套方式，CPU 是不响应的，因为属于同一级，都是 IR2.

  <span style="background:#d3f8b6">如果想要从片的 IR3 中断嵌套进从片的 IR4 中断，就需要 CPU 允许同级中断，所以要把主片设置为特殊完全嵌套方式。这样，从片的高优先级才能“真正”嵌套进从片的低优先级</span>。

  书上的解释是：在特殊完全嵌套方式下，当从片发出的某个中断请求正被服务时，该从片并不会被主片的优先级排除。因此该从片发出的其他更高优先级中断请求将被主片识别，主片会立刻向 CPU 发出中断。而在上述普通嵌套方式中，当一个从片中断请求正在被服务时，该从片会被主片屏蔽。因此该从片发出的更高优先级的中断请求就不能被处理

- 初始化流程
  ![](https://pan.lmio.xyz/pic/24fa565fa7a01d4d21ab029b21f561b7.png)
- 初始化命令字
	- ICW1
  ![](https://pan.lmio.xyz/pic/9d04d940d50b07789c17ef0d4355b970.png)
  ![](https://pan.lmio.xyz/pic/676bda03adc284562a5a54de924ae38c.png)
  - ICW2
  ![](https://pan.lmio.xyz/pic/5e019c9a3567da2e1c9839ad291d5135.png)


- ICW3 只有级联才需要设置 ICW3
  ![](https://pan.lmio.xyz/pic/8179697975d5c0b9ba2ec168bbf4f336.png)
  <font color="#ff0000">对于主片</font>，Si=1, 表示 `IRi` 接从片的 INT 引脚。说得啰嗦点，就是主片 S7~S0 各比特位对应级联的从片。哪位为 1 则表示主片的该中断请求引脚 IR 上信号来自从片，否则对应的 IR 引脚没有连从片。
  <font color="#ff0000">对于从片</font>，ID2~ID0 三个比特位对应各从片的标识号，即连接到主片的中断级。当某个从片接收到级联线（CAS2—CAS0）输入的值与自己的 ID2~ID0 相等时，表示此从片被选中。此时该从片应该向数据总线发送自己当前被选中的中断请求的中断号。
1. **教材 P183-184**
   ![](https://pan.lmio.xyz/pic/f0f8fa56939a76804a0d3ac968e17016.jpg)
   ![](https://pan.lmio.xyz/pic/cdaaeec7da52cf62c0e4d57ca9e30bec.jpg)
   ![](https://pan.lmio.xyz/pic/5aa89085ce7ffae09cdc452f00c3f424.jpg)
2. 教材 `P185` 【设计题】第 `1` 题、第 `2` 题  
   
   1. 单片 `8259A` 应用于 `8088` 系统，中断请求信号为边沿触发，中断类型码为 `60H~67H`，中断自动结束、特殊全嵌套、工作在非缓冲方式。端口地址为 `20H`、`21H`。
      - 确定初始化命令字  
        <font color=" #ff0000 ">ICW1</font>： 0 0 0 1 0 0 1 1 B=13H   
        <font color=" #ff0000 ">ICW2</font>： 0 1 1 0 0 0 0 0 B=60H   
        <font color=" #ff0000 ">ICW4</font>： 0 0 0 1 0 0 1 1 B=13H   
      - 初始化程序
```armasm
MOV DX, 20H ; DX 指向偶地址端口
MOV AL, 13H 
OUT DX, AL ; 写入 ICW1(边沿触发，单片，需要ICW4)
MOV DX, 21H ; DX 指向奇地址端口 
MOV AL, 60H 
OUT DX, AL ; 写入 ICW2(中断类型码从60H开始)
MOV AL, 13H 
OUT DX, AL ; 写入 ICW4(特殊全嵌套，自动EOI)

```

   2. 编写程序，屏蔽 `8259A` 的中断请求 `IR₀` 和 `IR₇`，开放其他中断请求，然后再将 `IR₀` 和 `IR₇` 屏蔽撤销。
```armasm
MOV DX, 21H ; DX 指向偶地址端口
MOV AL, 10000001B ; 屏蔽 8259A 的中断请求 IR₀和 IR₇，开放其他中断请求
OUT DX, AL
IN AL, 21H ; 从端口21H读取一字节到AL
AND AL, 01111110B ; 撤销IR₀和 IR₇的屏蔽
OUT DX, AL
```
  
3. 选做题![](https://pan.lmio.xyz/pic/2ea3d485c4cd22b96ce3f5caadb64545.png)
- 确定初始化命令字和操作命令字
  设主从片均采用边沿触发，级联，不使用 ICW4 则命令字为  
  
| 命令字  | 主片        | 从片        |
|:-----|:----------|:----------|
| ICW1 | 00010000B | 00010000B |
| ICW2 | 01000000B | 00110000B |
| ICW3 | 00001000B | 00000011B |


```armasm
初始化程序:
MOV AL, 10H
OUT FFE8H, AL
MOV DX, FFFAH
OUT DX, AL
MOV DX, FFFBH
MOV AL, 40H
OUT FFF9H, AL
MOV AL, 30H
OUT DX, AL
MOV AL, 08H
OUT FFF9H, AL
MOV AL, 03H
OUT DX, AL
```